services:
  # Build the WASM plugin locally
  wasm-builder:
    image: golang:1.25-bookworm
    container_name: wasm-builder
    working_dir: /src
    command: sh -c "GOOS=wasip1 GOARCH=wasm go build -buildmode=c-shared -ldflags '-X main.version=${VERSION:-dev}' -o /output/plugin.wasm main.go && echo 'WASM plugin built successfully'"
    volumes:
      - ./:/src:ro
      - wasm-output:/output
    environment:
      - VERSION=${VERSION:-dev}

  # Debug HTTP backend that returns various status codes
  http-debug:
    image: ghcr.io/ishioni/http-debug:0.0.2
    container_name: http-debug
    ports:
      - "8080:8080"

  # Envoy proxy with WASM plugin
  envoy:
    image: envoyproxy/envoy:v1.33.0
    container_name: envoy-wasm
    ports:
      - "10000:10000"
      - "9901:9901" # Admin interface
    volumes:
      - ./envoy.yaml:/etc/envoy/envoy.yaml:ro
      - wasm-output:/etc/envoy/wasm:ro
    depends_on:
      wasm-builder:
        condition: service_completed_successfully
      http-debug:
        condition: service_started
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]

volumes:
  wasm-output:
